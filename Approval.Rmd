---
title: "Presidential Approval"
author: "Ed Young"
date:  '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    css: styles.css
    highlight: null
    theme: null
  df_print: kable
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
     echo = FALSE,     # Hides code in rendered report
     warning = FALSE,  # Suppresses warnings
     message = FALSE,  # Suppresses messages
     cache = FALSE     # Disables caching
)

library(here)     # Helps manage file paths
source(here("R", "load_packages.R"))     # Custom script to load additional packages

```

```{r helpers, include=FALSE}
# Helper function to fit a LOESS curve with optional weights and 95% CIs
fit_loess <- function(data, span = 0.5, weight_col = NULL) {
  weights <- if (!is.null(weight_col)) data[[weight_col]] else NULL
  
  model <- loess(
    percentage ~ as.numeric(end_date),
    data = data,
    weights = weights,
    span = span
  )
  
  preds <- predict(model, newdata = data.frame(end_date = as.numeric(data$end_date)), se = TRUE)
  
  data %>%
    mutate(
      fit = preds$fit,
      se = preds$se.fit,
      ci_upper = fit + 1.96 * se,
      ci_lower = fit - 1.96 * se
    )
}

# Define pollsters used by the New York Times
selected_pollsters <- c(
  "Ipsos", "American Research Group", 
  "Beacon Research/Shaw & Company Research", "Gallup", "AtlasIntel",
  "Hart Research Associates/Public Opinion Strategies", "Quinnipiac University",
  "Emerson College", "CNN/SSRS", "Cygnal Political", "Public Opinion Strategies",
  "Marist College", "Marquette Law School", "Pew Research Center"
)

```

```{r download-data}

# Define the URL and the local file path
url <- "https://www.nytimes.com/newsgraphics/polls/approval/president.csv"
data_dir <- here("data")
file_path <- file.path(data_dir, "president.csv")

# Determine whether a download is needed:
# - Either the file doesn't exist...
# - Or the file exists but was last modified before today.
download_needed <- !file.exists(file_path) || 
  difftime(Sys.time(), file.info(file_path)$mtime, units = "hours") > 6

if (download_needed) {
  download.file(url, file_path, mode = "wb")
  message("Downloaded a fresh copy of president.csv.")
} else {
  message("The president.csv file is already up-to-date; no download needed.")
}
```

```{r read-data}

# Read the downloaded NYT presidential approval data
president <- readr::read_csv(file_path, show_col_types = FALSE)

# Ensure end_date is parsed correctly (M/D/YY format)
president$end_date <- lubridate::mdy(president$end_date)

```

```{r date-diagnostic, eval=FALSE, echo=FALSE}

file.info(file_path)$mtime


# Check the structure of the dataset
glimpse(president)

# See the first and last dates in the data
summary(president$end_date)

# Optional: explicitly check latest date
latest <- max(president$end_date, na.rm = TRUE)
cat("Latest date in dataset:", latest, "\n")

# Visual histogram of poll counts by end date
ggplot(president, aes(x = end_date)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "white") +
  labs(title = "Distribution of Poll End Dates",
       x = "End Date",
       y = "Number of Polls") +
  theme_minimal()
```

# I am using the New York Times Presidential Approval Polls to look at trends over time.  

##  The first graph is the raw data with LOESS smoothing curves.

```{r raw}

# Reshape the data into long format for easier plotting
president_long <- pivot_longer(president, 
                               cols = c("yes", "no"), 
                               names_to = "response", 
                               values_to = "percentage")

# Apply LOESS smoothing
loess_all <- bind_rows(
  fit_loess(filter(president_long, response == "yes"), span = 0.5),
  fit_loess(filter(president_long, response == "no"), span = 0.5)
)

# Identify latest points for labels
label_points <- loess_all %>%
  group_by(response) %>%
  filter(end_date == max(end_date, na.rm = TRUE)) %>%
  ungroup()

# Plot with raw data and LOESS trend lines
ggplot(loess_all, aes(x = end_date, y = percentage, color = response)) +
  geom_point(alpha = 0.6) +
  geom_line(aes(y = fit), linewidth = 1) +
  geom_ribbon(aes(ymin = ci_upper, ymax = ci_upper, fill = response),
              alpha = 0.2, color = NA) +
  geom_text(data = label_points,
            aes(label = paste0("Latest: ", round(fit, 1), "%")),
            hjust = -0.1, vjust = -0.2, size = 3, show.legend = FALSE) +
  scale_color_manual(values = c("yes" = "red", "no" = "black")) +
  scale_fill_manual(values = c("yes" = "red", "no" = "black")) +
  labs(
    title = "All Polls with LOESS Smoothing (Fixed Span)",
    x = "Poll End Date",
    y = "Response (%)",
    color = "Response",
    fill = "Response"
  ) +
  theme_minimal() +
  xlim(min(loess_all$end_date), max(loess_all$end_date) + 10)
  
```

##  This second graph uses the same data, but, following the New York Times, I only include the following selected pollsters: Ipsos, American Research Group, Beacon Research/Shaw & Company Research, Gallup, AtlasIntel, Hart Research Associates/Public Opinion Strategies, Quinnipiac University, Emerson College, CNN/SSRS, Cygnal Political, Public Opinion Strategies, Marist College, Marquette Law School, Pew Research Center.  In addition, the data is weighted for recency, sample size and Probability Panel methodology. 

### Weights
<span style="display:block" id="math">
$$
\text{Weight}_i = 0.5 \cdot e^{-\log(2) \cdot \frac{\text{days ago}_i}{14}} 
\;+\; 0.3 \cdot \frac{\log(1 + \text{sample size})}{\max_j \log(1 + \text{sample size})} 
\;+\; 0.2 \cdot \mathbb{1}_{\{\text{methodology} = \text{``Probability Panel''}\}}
$$
</span>

```{r weighted}

# Create a weighting column
# Define reference date as most recent date in the dataset
latest_date <- max(president$end_date, na.rm = TRUE)

# Apply filters and compute weight
president_weight <- president %>%
  filter(pollster %in% selected_pollsters) %>%
  mutate(
    days_ago = as.numeric(latest_date - end_date),
    time_weight = exp(-log(2) * days_ago / 14), # Time decay: exponential decay with half-life of 14 days
    size_weight = log1p(sample_size), # Sample size weight: log-scaled and normalized
    size_weight = size_weight / max(size_weight, na.rm = TRUE),
    is_prob_panel = grepl("Probability Panel", methodology, ignore.case = TRUE) &
                    !grepl("Nonprobability Panel", methodology, ignore.case = TRUE),
    method_weight = ifelse(is_prob_panel, 1, 0), # Methodology weight: +1 if Probability Sample, else 0
    weight = (0.5 * time_weight) + 
             (0.3 * size_weight) + 
             (0.2 * method_weight) # Final composite weight (can be tuned)
  )

# Reshape to long format
president_weight_long <- pivot_longer(president_weight, 
                               cols = c("yes", "no"), 
                               names_to = "response", 
                               values_to = "percentage")

# Helper function to fit LOESS and compute 95% confidence intervals
fit_loess <- function(data, span = 0.5, weight_col = NULL) {
  weights <- if (!is.null(weight_col)) data[[weight_col]] else NULL
  
  model <- loess(
    percentage ~ as.numeric(end_date),
    data = data,
    weights = weights,
    span = span
  )
  
  preds <- predict(model, newdata = data.frame(end_date = as.numeric(data$end_date)), se = TRUE)
  
  data %>%
    mutate(
      fit = preds$fit,
      se = preds$se.fit,
      ci_upper = fit + 1.96 * se,
      ci_lower = fit - 1.96 * se
    )
}


# Fit LOESS models for each response group using composite weights
yes_data <- fit_loess(
  filter(president_weight_long, response == "yes"),
  span = 0.5,
  weight_col = "weight"
)

no_data <- fit_loess(
  filter(president_weight_long, response == "no"),
  span = 0.5,
  weight_col = "weight"
)

# Combine for plotting
loess_all <- bind_rows(yes_data, no_data)

label_points <- loess_all %>%
  group_by(response) %>%
  filter(end_date == max(end_date, na.rm = TRUE)) %>%
  ungroup()

# Plot with smoothed loess lines
ggplot(loess_all, aes(x = end_date, y = percentage, color = response)) +
  geom_point(alpha = 0.3) +
  geom_line(aes(y = fit), size = 1) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = response), 
              alpha = 0.2, color = NA) +
  geom_text(data = label_points, 
            aes(x = end_date, y = fit, label = paste0("Latest: ", round(fit, 1), "%")),
            hjust = -0.1, vjust = -0.2, size = 3, show.legend = FALSE) +
  scale_color_manual(values = c("yes" = "red", "no" = "black")) +
  scale_fill_manual(values = c("yes" = "red", "no" = "black")) +
  labs(title = "Selected Pollsters Weighted for Recency, Sample Size, and Methodology",
       x = "Poll End Date",
       y = "Response (%)",
       color = "Response",
       fill = "Response") +
  theme_minimal() +
  xlim(min(loess_all$end_date), max(loess_all$end_date) + 10)  # give labels some space
```

# Here are some diagnostics to help think about these different factors

## First is a graph using only the Probability Panels

```{r Probability Diagnostic}
# Filter to only Probability Panel
president_prob <- president %>%
  filter(
    grepl("Probability Panel", methodology, ignore.case = TRUE) & 
    !grepl("Nonprobability Panel", methodology, ignore.case = TRUE)
  )

# Reshape into long format
president_long <- pivot_longer(president_prob, 
                               cols = c("yes", "no"), 
                               names_to = "response", 
                               values_to = "percentage")

# Fit LOESS models using your helper
loess_all <- bind_rows(
  fit_loess(filter(president_long, response == "yes"), span = 0.5),
  fit_loess(filter(president_long, response == "no"), span = 0.5)
)

# Identify label points
label_points <- loess_all %>%
  group_by(response) %>%
  filter(end_date == max(end_date, na.rm = TRUE)) %>%
  ungroup()

# Plot with trend lines
ggplot(loess_all, aes(x = end_date, y = percentage, color = response)) +
  geom_point(alpha = 0.6) +
  geom_line(aes(y = fit), linewidth = 1) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = response), alpha = 0.2, color = NA) +
  geom_text(data = label_points,
            aes(label = paste0("Latest: ", round(fit, 1), "%")),
            hjust = -0.1, vjust = -0.2, size = 3, show.legend = FALSE) +
  scale_color_manual(values = c("yes" = "red", "no" = "black")) +
  scale_fill_manual(values = c("yes" = "red", "no" = "black")) +
  labs(
    title = "Probability Panel Polls Only",
    x = "Poll End Date",
    y = "Response (%)",
    color = "Response",
    fill = "Response"
  ) +
  theme_minimal() +
  xlim(min(loess_all$end_date), max(loess_all$end_date) + 10)

```

## This is a graph using only selected pollsters

```{r selected}

# Reshape the data into long format for easier plotting
president_long <- president %>%
  filter(pollster %in% selected_pollsters) %>%
  pivot_longer(cols = c("yes", "no"), 
               names_to = "response", 
               values_to = "percentage")

loess_all <- bind_rows(
  fit_loess(filter(president_long, response == "yes"), span = 0.5),
  fit_loess(filter(president_long, response == "no"), span = 0.5)
)

label_points <- loess_all %>%
  group_by(response) %>%
  filter(end_date == max(end_date, na.rm = TRUE)) %>%
  ungroup()

# Plot
ggplot(loess_all, aes(x = end_date, y = percentage, color = response)) +
  geom_point(alpha = 0.6) +
  geom_line(aes(y = fit), linewidth = 1) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = response),
              alpha = 0.2, color = NA) +
  geom_text(data = label_points,
            aes(label = paste0("Latest: ", round(fit, 1), "%")),
            hjust = -0.1, vjust = -0.2, size = 3, show.legend = FALSE) +
  scale_color_manual(values = c("yes" = "red", "no" = "black")) +
  scale_fill_manual(values = c("yes" = "red", "no" = "black")) +
  labs(
    title = "Selected Pollsters Only",
    x = "Poll End Date",
    y = "Response (%)",
    color = "Response",
    fill = "Response"
  ) +
  theme_minimal() +
  xlim(min(loess_all$end_date), max(loess_all$end_date) + 10)

```

## This a graph weighted only by sample size

```{r Sample Size Diagnostic}

# Compute log-scaled, normalized sample size weight
president_size <- president %>%
  mutate(
    size_weight = log1p(sample_size),
    size_weight = size_weight / max(size_weight, na.rm = TRUE)
  )

# Reshape to long format
president_size_long <- pivot_longer(president_size, 
                                    cols = c("yes", "no"), 
                                    names_to = "response", 
                                    values_to = "percentage")

# Fit LOESS models using sample size as weight
loess_all <- bind_rows(
  fit_loess(filter(president_size_long, response == "yes"), span = 0.5, weight_col = "size_weight"),
  fit_loess(filter(president_size_long, response == "no"),  span = 0.5, weight_col = "size_weight")
)

# Label points for latest date
label_points <- loess_all %>%
  group_by(response) %>%
  filter(end_date == max(end_date, na.rm = TRUE)) %>%
  ungroup()

# Plot
ggplot(loess_all, aes(x = end_date, y = percentage, color = response)) +
  geom_point(alpha = 0.4) +
  geom_line(aes(y = fit), linewidth = 1) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = response), alpha = 0.2, color = NA) +
  geom_text(data = label_points,
            aes(label = paste0("Latest: ", round(fit, 1), "%")),
            hjust = -0.1, vjust = -0.2, size = 3, show.legend = FALSE) +
  scale_color_manual(values = c("yes" = "red", "no" = "black"), drop = FALSE) +
  scale_fill_manual(values = c("yes" = "red", "no" = "black"), drop = FALSE) +
  labs(
    title = "LOESS Smoothing Weighted by Sample Size Only",
    x = "Poll End Date",
    y = "Response (%)",
    color = "Response",
    fill = "Response"
  ) +
  theme_minimal() +
  xlim(min(loess_all$end_date), max(loess_all$end_date) + 10)

```

## Polls weighted only for recency

```{r recency}
# Compute time decay weight (half-life = 14 days)
latest_date <- max(president$end_date, na.rm = TRUE)

president_recency <- president %>%
  mutate(
    days_ago = as.numeric(latest_date - end_date),
    time_weight = exp(-log(2) * days_ago / 14)
  )

# Reshape to long format
president_recency_long <- pivot_longer(president_recency,
                                       cols = c("yes", "no"),
                                       names_to = "response",
                                       values_to = "percentage")

# Fit LOESS using recency weight
loess_all <- bind_rows(
  fit_loess(filter(president_recency_long, response == "yes"), span = 0.5, weight_col = "time_weight"),
  fit_loess(filter(president_recency_long, response == "no"),  span = 0.5, weight_col = "time_weight")
)

# Label latest points
label_points <- loess_all %>%
  group_by(response) %>%
  filter(end_date == max(end_date, na.rm = TRUE)) %>%
  ungroup()

# Plot
ggplot(loess_all, aes(x = end_date, y = percentage, color = response)) +
  geom_point(alpha = 0.3) +
  geom_line(aes(y = fit), size = 1) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper, fill = response), alpha = 0.2, color = NA) +
  geom_text(data = label_points,
            aes(label = paste0("Latest: ", round(fit, 1), "%")),
            hjust = -0.1, vjust = -0.2, size = 3, show.legend = FALSE) +
  scale_color_manual(values = c("yes" = "red", "no" = "black")) +
  scale_fill_manual(values = c("yes" = "red", "no" = "black")) +
  labs(
    title = "LOESS Smoothing Weighted for Recency Only",
    x = "Poll End Date",
    y = "Response (%)",
    color = "Response",
    fill = "Response"
  ) +
  theme_minimal() +
  xlim(min(loess_all$end_date), max(loess_all$end_date) + 10)

```

##  Plot weight vs. end_date to see how time decay is working:

```{r Time Decau Diagnostic}
ggplot(president_weight, aes(x = end_date, y = weight)) +
  geom_point(alpha = 0.7) +
  labs(title = "Poll Weights Over Time",
       x = "Poll End Date",
       y = "Computed Weight") +
  theme_minimal()
```

##  break down the contributions of time, sample size, and methodology to the final weight

```{r Variable Contribution Diagnostic}
president_weight_long <- president_weight %>%
  select(end_date, time_weight, size_weight, method_weight) %>%
  pivot_longer(cols = -end_date, names_to = "component", values_to = "value")

ggplot(president_weight_long, aes(x = end_date, y = value, color = component)) +
  geom_line(stat = "summary", fun = mean) +
  labs(title = "Average Contribution of Weight Components Over Time",
       x = "Poll End Date", y = "Component Value",
       color = "Component") +
  theme_minimal()

# Visual histogram of poll counts by end date
ggplot(president_weight_long, aes(x = end_date)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "white") +
  labs(title = "Distribution of Poll End Dates",
       x = "End Date",
       y = "Number of Polls") +
  theme_minimal()
```